<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bawi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sidebar-header p {
            opacity: 0.8;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .nav-menu {
            padding: 2rem 0;
        }

        .nav-item {
            padding: 0.75rem 2rem;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background-color: rgba(255,255,255,0.2);
            border-right: 3px solid white;
        }

        .nav-item i {
            width: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e1e5e9;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info span {
            font-weight: 600;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* Dashboard Sections */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .stat-card .change {
            font-size: 0.9rem;
            color: #28a745;
        }

        .stat-card .change.negative {
            color: #dc3545;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 300px;
        }

        .chart-container h3 {
            margin-bottom: 1rem;
            color: #333;
            font-weight: 600;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            color: #333;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-box input {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .search-box select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.resolved {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.dismissed {
            background: #e2e3e5;
            color: #383d41;
        }

        .btn-primary, .btn-success, .btn-warning, .btn-danger {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 0.25rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
            border-top: 1px solid #e1e5e9;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: #333;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading i {
            animation: spin 1s linear infinite;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .notification-success {
            background: #28a745;
        }

        .notification-error {
            background: #dc3545;
        }

        .notification-info {
            background: #17a2b8;
        }

        .notification-warning {
            background: #ffc107;
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Chart Container Improvements */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            height: 300px;
        }

        .chart-container h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        /* Table Improvements */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #dee2e6;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        /* Button Improvements */
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin: 2px;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Modal Improvements */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        /* Form Improvements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Stats Grid Improvements */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                height: 250px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 200px;
            }
        }

        .notification.success { background-color: #4CAF50; }
        .notification.error { background-color: #f44336; }
        .notification.info { background-color: #2196F3; }
        
        /* Section styles */
        .section { margin-top: 20px; }
        .section:not(:first-child) { display: none; }
        
        /* Table styles */
        .table-container { overflow-x: auto; margin-top: 20px; }
        .table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .table th { background-color: #f8f9fa; font-weight: 600; color: #333; }
        .table tr:hover { background-color: #f5f5f5; }
        
        /* Status badges */
        .status { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status.active { background-color: #e8f5e8; color: #2e7d32; }
        .status.inactive { background-color: #ffebee; color: #c62828; }
        .status.banned { background-color: #fff3e0; color: #ef6c00; }
        .status.pending { background-color: #fff8e1; color: #f57f17; }
        .status.resolved { background-color: #e8f5e8; color: #2e7d32; }
        .status.dismissed { background-color: #f3e5f5; color: #7b1fa2; }
        
        /* Button styles */
        .btn-small { padding: 6px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; margin: 2px; }
        .btn-warning { background-color: #ff9800; color: white; }
        .btn-success { background-color: #4CAF50; color: white; }
        .btn-primary { background-color: #2196F3; color: white; }
        .btn-danger { background-color: #f44336; color: white; }
        
        /* Analytics grid */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
        .analytics-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .analytics-card h3 { margin-top: 0; color: #333; }

        /* Management Sections */
        .management-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .section-content {
            margin-bottom: 1rem;
        }

        .section-description {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .announcement-list {
            list-style-type: none;
            padding-left: 0;
        }

        .announcement-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .announcement-list li:last-child {
            border-bottom: none;
        }

        .announcement-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .announcement-header h4 {
            margin: 0;
            color: #333;
            font-size: 1.1rem;
        }

        .announcement-type {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .announcement-type.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .announcement-type.warning {
            background: #fff3cd;
            color: #856404;
        }

        .announcement-type.success {
            background: #d4edda;
            color: #155724;
        }

        .announcement-type.error {
            background: #f8d7da;
            color: #721c24;
        }

        .announcement-item p {
            margin: 0.5rem 0;
            color: #666;
            line-height: 1.5;
        }

        .announcement-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .announcement-footer small {
            color: #999;
        }

        .notification-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
        }

        .checkmark {
            width: 16px;
            height: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        .checkbox-label input:checked + .checkmark {
            background-color: #667eea;
            border-color: #667eea;
        }

        /* Reported Rooms Styles */
        .room-info, .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .room-info strong, .user-info strong {
            font-weight: 600;
            color: #333;
        }
        
        .room-info small, .user-info small {
            color: #666;
            font-size: 0.8em;
        }
        
        .description-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .description-cell:hover {
            white-space: normal;
            overflow: visible;
            position: relative;
            z-index: 10;
            background: white;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        
        .badge-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        
        .badge-secondary {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-shield-alt"></i> Bawi Admin</h2>
                <p>Administrative Dashboard</p>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-section="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </div>
                <div class="nav-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </div>
                <div class="nav-item" data-section="reports">
                    <i class="fas fa-flag"></i>
                    <span>Reports</span>
                </div>
                <div class="nav-item" data-section="reportedRooms">
                    <i class="fas fa-flag"></i>
                    <span>Reported Rooms</span>
                </div>
                <div class="nav-item" data-section="rooms">
                    <i class="fas fa-door-open"></i>
                    <span>Room Management</span>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Admin Dashboard</h1>
                <div class="user-info">
                    <span id="admin-username"></span>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="overviewSection" class="section">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card"><h3>Users</h3><div class="value" id="totalUsers">-</div></div>
                    <div class="stat-card"><h3>Active</h3><div class="value" id="activeUsers">-</div></div>
                    <div class="stat-card"><h3>Inactive</h3><div class="value" id="inactiveUsers">-</div></div>
                    <div class="stat-card"><h3>Avg Age</h3><div class="value" id="avgAge">-</div></div>
                    <div class="stat-card"><h3>Rooms</h3><div class="value" id="totalRooms">-</div></div>
                    <div class="stat-card"><h3>Messages</h3><div class="value" id="totalMessages">-</div></div>
                    <div class="stat-card"><h3>Banned</h3><div class="value" id="bannedUsers">-</div></div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-container"><h3>User Growth</h3><canvas id="userGrowthChart"></canvas></div>
                    <div class="chart-container"><h3>Active vs Inactive</h3><canvas id="activeInactiveChart"></canvas></div>
                    <div class="chart-container"><h3>Gender</h3><canvas id="genderChart"></canvas></div>
                    <div class="chart-container"><h3>Platform</h3><canvas id="platformChart"></canvas></div>
                    <div class="chart-container"><h3>Message Traffic</h3><canvas id="messageTrafficChart"></canvas></div>
                    <div class="chart-container"><h3>Engagement Heatmap</h3><canvas id="engagementHeatmap"></canvas></div>
                </div>

                <!-- Management Sections -->
                <div id="announcementSection" class="management-section">
                    <div class="section-header">
                        <h2><i class="fas fa-bullhorn"></i> Announcements</h2>
                        <button class="btn-primary" id="createAnnouncementBtn">
                            <i class="fas fa-plus"></i> New Announcement
                        </button>
                    </div>
                    <div class="section-content">
                        <ul id="announcementList" class="announcement-list"></ul>
                    </div>
                </div>

                <div id="broadcastSection" class="management-section">
                    <div class="section-header">
                        <h2><i class="fas fa-broadcast-tower"></i> Broadcast Message</h2>
                        <button class="btn-primary" id="broadcastBtn">
                            <i class="fas fa-paper-plane"></i> Send Broadcast
                        </button>
                    </div>
                    <div class="section-content">
                        <p class="section-description">Send a message to all users in the system.</p>
                    </div>
                </div>

                <div id="notificationRulesSection" class="management-section">
                    <div class="section-header">
                        <h2><i class="fas fa-bell"></i> Notification Rules</h2>
                    </div>
                    <div class="section-content">
                        <form id="notificationRulesForm" class="notification-form">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="notifyOnBan" name="notifyOnBan">
                                    <span class="checkmark"></span>
                                    Notify when user is banned
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="notifyOnUnban" name="notifyOnUnban">
                                    <span class="checkmark"></span>
                                    Notify when user is unbanned
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="notifyOnAnnouncement" name="notifyOnAnnouncement">
                                    <span class="checkmark"></span>
                                    Notify on new announcement
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="emailNotifications" name="emailNotifications">
                                    <span class="checkmark"></span>
                                    Enable email notifications
                                </label>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> Save Rules
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="section" style="display: none;">
                <h2>User Management</h2>
                <div class="table-container">
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="section" style="display: none;">
                <h2>User Reports</h2>
                <div class="table-container">
                    <table class="table" id="reportsTable">
                        <thead>
                            <tr>
                                <th>Reporter</th>
                                <th>Reported User</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reported Rooms Section -->
            <div id="reportedRoomsSection" class="section">
                <div class="section-header">
                    <h2><i class="fas fa-flag"></i> Reported Rooms</h2>
                    <p>Manage rooms that have been reported by users</p>
                </div>
                
                <div class="content-card">
                    <div class="card-header">
                        <h3>Room Reports</h3>
                        <div class="filters">
                            <select id="reportStatusFilter">
                                <option value="all">All Reports</option>
                                <option value="pending">Pending</option>
                                <option value="resolved">Resolved</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="reportedRoomsTable">
                            <thead>
                                <tr>
                                    <th>Room Name</th>
                                    <th>Reported By</th>
                                    <th>Reason</th>
                                    <th>Description</th>
                                    <th>Report Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportedRoomsTableBody">
                                <!-- Room reports will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="reportedRoomsLoading" class="loading-spinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Loading reported rooms...
                    </div>
                    
                    <div id="noReportedRooms" class="empty-state" style="display: none;">
                        <i class="fas fa-flag"></i>
                        <h3>No Reported Rooms</h3>
                        <p>There are no room reports to display.</p>
                    </div>
                </div>
            </div>

            <!-- Room Management Section -->
            <div id="roomsSection" class="section" style="display: none;">
                <h2>Room Management</h2>
                <div style="margin-bottom: 1rem;">
                    <button class="btn-primary" onclick="loadRooms()">
                        <i class="fas fa-refresh"></i> Refresh Rooms
                    </button>
                    <button class="btn-warning" onclick="testRoomsAPI()">
                        <i class="fas fa-bug"></i> Test API
                    </button>
                    <button class="btn-info" onclick="testAuth()">
                        <i class="fas fa-key"></i> Test Auth
                    </button>
                </div>
                <div class="table-container">
                    <table class="table" id="roomsTable">
                        <thead>
                            <tr>
                                <th>Room Name</th>
                                <th>Created By</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="roomsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">
                                    Click "Refresh Rooms" to load room data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="section" style="display: none;">
                <h2>Detailed Analytics</h2>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>User Demographics</h3>
                        <canvas id="demographicsChart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>Message Patterns</h3>
                        <canvas id="messagePatternsChart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>Room Activity</h3>
                        <canvas id="roomActivityChart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>User Engagement</h3>
                        <canvas id="userEngagementChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Announcement Modal -->
            <div class="modal" id="announcementModal">
                <div class="modal-content">
                    <div class="modal-header"><h3>New Announcement</h3><span class="close" id="closeAnnouncementModal">&times;</span></div>
                    <form id="announcementForm">
                        <label>Title</label><input type="text" id="announcementTitle" name="title" required><br>
                        <label>Message</label><textarea id="announcementMessage" name="message" required></textarea><br>
                        <label>Type</label>
                        <select id="announcementType" name="type" required>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="success">Success</option>
                            <option value="error">Error</option>
                        </select><br>
                        <label>Target Users</label>
                        <select id="announcementTarget" name="target" required>
                            <option value="all">All Users</option>
                            <option value="specific">Specific Users</option>
                        </select><br>
                        <div id="userSelectionContainer" style="display: none;">
                            <label>Select Users</label>
                            <div id="userSelectionList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                                <!-- Users will be loaded here -->
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Send</button>
                    </form>
                </div>
            </div>

            <!-- Broadcast Modal -->
            <div class="modal" id="broadcastModal">
                <div class="modal-content">
                    <div class="modal-header"><h3>Broadcast Message</h3><span class="close" id="closeBroadcastModal">&times;</span></div>
                    <form id="broadcastForm">
                        <label>Message</label><textarea id="broadcastMessage" name="message" required></textarea><br>
                        <label>Type</label>
                        <select id="broadcastType" name="type" required>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="success">Success</option>
                            <option value="error">Error</option>
                        </select><br>
                        <button type="submit" class="btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div id="banModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ban User</h3>
                <span class="close" onclick="closeModal('banModal')">&times;</span>
            </div>
            <form id="banForm">
                <div class="form-group">
                    <label for="banReason">Reason for Ban</label>
                    <textarea id="banReason" required></textarea>
                </div>
                <div class="form-group">
                    <label for="banType">Ban Type</label>
                    <select id="banType" required>
                        <option value="temporary">Temporary</option>
                        <option value="permanent">Permanent</option>
                    </select>
                </div>
                <div class="form-group" id="durationGroup">
                    <label for="banDuration">Duration (hours)</label>
                    <input type="number" id="banDuration" min="1" value="24">
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-btn btn-warning" onclick="closeModal('banModal')">Cancel</button>
                    <button type="submit" class="action-btn btn-danger">Ban User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Details</h3>
                <span class="close" onclick="closeModal('reportModal')">&times;</span>
            </div>
            <div id="reportDetails"></div>
            <div class="modal-actions">
                <button type="button" class="action-btn btn-warning" onclick="closeModal('reportModal')">Close</button>
                <button type="button" class="action-btn btn-primary" onclick="updateReportStatus('resolved')">Mark Resolved</button>
                <button type="button" class="action-btn btn-danger" onclick="updateReportStatus('dismissed')">Dismiss</button>
            </div>
        </div>
    </div>

    <script>
        // Admin Dashboard JavaScript
        // Global chart registry to track ALL charts
        const globalChartRegistry = new Map();
        
        // Simple chart creation function
        function createChart(canvasId, config) {
            console.log('Creating chart for:', canvasId);
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found:', canvasId);
                return null;
            }
            
            console.log('Canvas found, dimensions:', canvas.width, 'x', canvas.height);
            
            // Destroy existing chart if it exists
            if (globalChartRegistry.has(canvasId)) {
                const existingChart = globalChartRegistry.get(canvasId);
                if (existingChart && typeof existingChart.destroy === 'function') {
                    console.log('Destroying existing chart:', canvasId);
                    existingChart.destroy();
                }
            }
            
            // Create new chart
            const ctx = canvas.getContext('2d');
            console.log('Creating new chart with config:', config);
            const chart = new Chart(ctx, config);
            globalChartRegistry.set(canvasId, chart);
            console.log('Chart created successfully:', canvasId);
            
            return chart;
        }
        
        // Clean up charts when switching sections
        function cleanupCharts() {
            globalChartRegistry.forEach((chart, canvasId) => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            globalChartRegistry.clear();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            
            // Initialize authentication and basic setup first
            checkAuth();
            setupEventListeners();
            
            // Load dashboard data after a short delay to ensure DOM is ready
            setTimeout(() => {
                loadDashboard();
            }, 100);
        });

        // Clean up charts when page is unloaded
        window.addEventListener('beforeunload', function() {
            cleanupCharts();
        });

        // Clean up charts when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                cleanupCharts();
            }
        });

        // Check admin authentication
        async function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }
            
            try {
                const response = await fetch('/api/admin/verify', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                localStorage.removeItem('adminToken');
                window.location.href = '/admin/login';
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                console.log('Loading dashboard data...');
                
                // Show the overview section by default
                document.getElementById('overviewSection').style.display = 'block';
                document.querySelector('[data-section="overview"]').classList.add('active');
                
                // Load stats and notification rules
                await Promise.all([
                    loadStats(),
                    loadUserGrowth(),
                    loadActiveInactive(),
                    loadGenderDistribution(),
                    loadPlatformStats(),
                    loadMessageTraffic(),
                    loadEngagementHeatmap(),
                    loadNotificationRules() // Add this to load notification rules
                ]);
                
                console.log('Dashboard data loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load basic stats
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.stats.totalUsers;
                    document.getElementById('activeUsers').textContent = data.stats.activeUsers;
                    document.getElementById('inactiveUsers').textContent = data.stats.inactiveUsers;
                    document.getElementById('totalRooms').textContent = data.stats.totalRooms;
                    document.getElementById('totalMessages').textContent = data.stats.totalMessages;
                    document.getElementById('bannedUsers').textContent = data.stats.bannedUsers;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load users for user management
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.username || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>
                                <span class="status-badge ${user.isBanned ? 'inactive' : 'active'}">
                                    ${user.isBanned ? 'Banned' : 'Active'}
                                </span>
                            </td>
                            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                            <td>
                                ${user.isBanned ? 
                                    `<button class="btn-success" onclick="unbanUser('${user._id}')">Unban</button>` :
                                    `<button class="btn-warning" onclick="banUser('${user._id}')">Ban</button>`
                                }
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load reports
        async function loadReports() {
            try {
                const response = await fetch('/api/admin/reports');
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('reportsTableBody');
                    tbody.innerHTML = '';
                    
                    data.reports.forEach(report => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${report.reporter ? report.reporter.username : 'Unknown'}</td>
                            <td>${report.reportedUser ? report.reportedUser.username : 'Unknown'}</td>
                            <td>${report.reason}</td>
                            <td>
                                <span class="status-badge ${report.status}">
                                    ${report.status}
                                </span>
                            </td>
                            <td>${new Date(report.timestamp).toLocaleDateString()}</td>
                            <td>
                                ${report.status === 'pending' ? 
                                    `                                    <button class="btn-success" onclick="resolveUserReport('${report._id}', 'resolved')">Resolve</button>
                                    <button class="btn-warning" onclick="resolveUserReport('${report._id}', 'dismissed')">Dismiss</button>` :
                                    `<span>${report.status}</span>`
                                }
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        // Load analytics
        async function loadAnalytics() {
            console.log('=== LOADING ANALYTICS ===');
            
            try {
                console.log('Starting to load analytics charts...');
                
                // Load all charts in parallel
                await Promise.all([
                    loadUserGrowth(),
                    loadActiveInactive(),
                    loadPlatformStats(),
                    loadMessageTraffic(),
                    loadEngagementHeatmap()
                ]);
                
                console.log('Analytics loaded successfully');
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Load user registration chart
        async function loadUserRegistration() {
            try {
                const response = await fetch('/api/admin/analytics/registration');
                const data = await response.json();
                
                if (data.success) {
                    const config = {
                        type: 'line',
                        data: {
                            labels: data.registration.map(item => item.date),
                            datasets: [{
                                label: 'New Users',
                                data: data.registration.map(item => item.count),
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: false }
                            }
                        }
                    };
                    
                    createChart('userRegistrationChart', config);
                }
            } catch (error) {
                console.error('Error loading user registration:', error);
            }
        }

        // Load system activity chart
        async function loadSystemActivity() {
            try {
                const response = await fetch('/api/admin/analytics/activity');
                const data = await response.json();
                
                if (data.success) {
                    const config = {
                        type: 'line',
                        data: {
                            labels: data.activity.map(item => item.date),
                            datasets: [{
                                label: 'Messages',
                                data: data.activity.map(item => item.messages),
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: false }
                            }
                        }
                    };
                    
                    createChart('systemActivityChart', config);
                }
            } catch (error) {
                console.error('Error loading system activity:', error);
            }
        }

        // Load message activity chart
        async function loadMessageActivity() {
            try {
                const response = await fetch('/api/admin/analytics/messages');
                const data = await response.json();
                
                if (data.success) {
                    const config = {
                        type: 'bar',
                        data: {
                            labels: data.messages.map(item => item.type),
                            datasets: [{
                                label: 'Messages',
                                data: data.messages.map(item => item.count),
                                backgroundColor: ['#FF5722', '#9C27B0', '#607D8B', '#795548']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: false }
                            }
                        }
                    };
                    
                    createChart('messageActivityChart', config);
                }
            } catch (error) {
                console.error('Error loading message activity:', error);
            }
        }

        // Load gender distribution pie chart
        async function loadGenderDistribution() {
            try {
                console.log('Loading gender distribution...');
                const response = await fetch('/api/admin/analytics/gender');
                const data = await response.json();
                console.log('Gender data received:', data);
                
                if (data.success) {
                    const config = {
                        type: 'pie',
                        data: {
                            labels: data.genderStats.map(item => item._id),
                            datasets: [{
                                data: data.genderStats.map(item => item.count),
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: false }
                            }
                        }
                    };
                    
                    createChart('genderChart', config);
                }
            } catch (error) {
                console.error('Error loading gender distribution:', error);
            }
        }

        // Load age stats
        async function loadAgeStats() {
            try {
                const response = await fetch('/api/admin/analytics/age');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('averageAge').textContent = Math.round(data.averageAge || 0);
                    document.getElementById('ageRange').textContent = `${data.minAge || 0} - ${data.maxAge || 0}`;
                }
            } catch (error) {
                console.error('Error loading age stats:', error);
            }
        }

        // Load platform stats pie chart
        async function loadPlatformStats() {
            try {
                console.log('Loading platform stats...');
                const response = await fetch('/api/admin/analytics/platform');
                const data = await response.json();
                console.log('Platform data received:', data);
                
                if (data.success) {
                    const config = {
                        type: 'doughnut',
                        data: {
                            labels: data.platformStats.map(item => item._id),
                            datasets: [{
                                data: data.platformStats.map(item => item.count),
                                backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Platform Usage' }
                            }
                        }
                    };
                    
                    createChart('platformChart', config);
                }
            } catch (error) {
                console.error('Error loading platform stats:', error);
            }
        }

        // Load language stats pie chart
        async function loadLanguageStats() {
            try {
                const response = await fetch('/api/admin/analytics/language');
                const data = await response.json();
                
                if (data.success) {
                    const config = {
                        type: 'doughnut',
                        data: {
                            labels: data.languageStats.map(item => item._id),
                            datasets: [{
                                data: data.languageStats.map(item => item.count),
                                backgroundColor: ['#FF5722', '#607D8B', '#795548', '#9E9E9E']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: false }
                            }
                        }
                    };
                    
                    createChart('languageChart', config);
                }
            } catch (error) {
                console.error('Error loading language stats:', error);
            }
        }

        // Load country stats pie chart
        async function loadCountryStats() {
            try {
                const response = await fetch('/api/admin/analytics/country');
                const data = await response.json();
                
                if (data.success) {
                    const config = {
                        type: 'doughnut',
                        data: {
                            labels: data.countryStats.map(item => item._id),
                            datasets: [{
                                data: data.countryStats.map(item => item.count),
                                backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#607D8B']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: false }
                            }
                        }
                    };
                    
                    createChart('countryChart', config);
                }
            } catch (error) {
                console.error('Error loading country stats:', error);
            }
        }

        // Load user growth chart
        async function loadUserGrowth() {
            try {
                const response = await fetch('/api/admin/analytics/growth');
                const data = await response.json();
                
                if (data.success) {
                    const config = {
                        type: 'line',
                        data: {
                            labels: data.growth.map(item => item.date),
                            datasets: [{
                                label: 'Total Users',
                                data: data.growth.map(item => item.count),
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: false }
                            }
                        }
                    };
                    
                    createChart('userGrowthChart', config);
                }
            } catch (error) {
                console.error('Error loading user growth:', error);
            }
        }

        // Load active vs inactive users
        async function loadActiveInactive() {
            try {
                console.log('Loading active vs inactive users...');
                const response = await fetch('/api/admin/analytics/active');
                const data = await response.json();
                console.log('Active/Inactive data received:', data);
                
                if (data.success) {
                    const config = {
                        type: 'pie',
                        data: {
                            labels: ['Active', 'Inactive'],
                            datasets: [{
                                data: [data.active, data.inactive],
                                backgroundColor: ['#4CAF50', '#FF5722']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Active vs Inactive Users' }
                            }
                        }
                    };
                    
                    createChart('activeInactiveChart', config);
                }
            } catch (error) {
                console.error('Error loading active/inactive users:', error);
            }
        }

        // Load message traffic chart
        async function loadMessageTraffic() {
            try {
                console.log('Loading message traffic...');
                const response = await fetch('/api/admin/analytics/message-traffic?period=7d');
                const data = await response.json();
                console.log('Message traffic data received:', data);
                
                if (data.success) {
                    const config = {
                        type: 'bar',
                        data: {
                            labels: data.messageTraffic.map(item => item._id),
                            datasets: [{
                                label: 'Messages',
                                data: data.messageTraffic.map(item => item.count),
                                backgroundColor: '#2196F3'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Message Traffic (7 Days)' }
                            }
                        }
                    };
                    
                    createChart('messageTrafficChart', config);
                }
            } catch (error) {
                console.error('Error loading message traffic:', error);
            }
        }

        // Load engagement heatmap
        async function loadEngagementHeatmap() {
            try {
                console.log('Loading engagement heatmap...');
                const response = await fetch('/api/admin/analytics/engagement-heatmap');
                const data = await response.json();
                console.log('Engagement heatmap data received:', data);
                
                if (data.success) {
                    // Create a simple bar chart showing hourly activity
                    const hours = Array.from({length: 24}, (_, i) => i);
                    const activityData = hours.map(hour => {
                        const item = data.engagementHeatmap.find(d => d._id === hour);
                        return item ? item.count : 0;
                    });
                    
                    const config = {
                        type: 'bar',
                        data: {
                            labels: hours.map(h => `${h}:00`),
                            datasets: [{
                                label: 'Messages per Hour',
                                data: activityData,
                                backgroundColor: '#2196F3',
                                borderColor: '#1976D2',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Hourly Message Activity' }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Number of Messages' }
                                },
                                x: {
                                    title: { display: true, text: 'Hour of Day' }
                                }
                            }
                        }
                    };
                    
                    createChart('engagementHeatmap', config);
                }
            } catch (error) {
                console.error('Error loading engagement heatmap:', error);
            }
        }

        // Load rooms
        async function loadRooms() {
            try {
                console.log('=== LOADING ROOMS ===');
                const token = localStorage.getItem('adminToken');
                console.log('Admin token:', token ? 'Found' : 'Not found');
                
                if (!token) {
                    console.error('No admin token found');
                    const tbody = document.getElementById('roomsTableBody');
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: red;">No admin token found. Please login again.</td></tr>';
                    return;
                }
                
                console.log('Making API request to /api/admin/rooms...');
                const response = await fetch('/api/admin/rooms', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Rooms data received:', data);
                
                if (data.success) {
                    const tbody = document.getElementById('roomsTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.rooms && data.rooms.length > 0) {
                        console.log(`Found ${data.rooms.length} rooms`);
                        data.rooms.forEach((room, index) => {
                            console.log(`Room ${index + 1}:`, room);
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${room.name}</td>
                                <td>${room.createdBy ? room.createdBy.username : 'Unknown'}</td>
                                <td>${room.type}</td>
                                <td>
                                    <span class="status-badge ${room.isActive ? 'active' : 'inactive'}">
                                        ${room.isActive ? 'Active' : 'Banned'}
                                    </span>
                                    ${!room.isActive && room.banReason ? `<div style='font-size:0.8em;color:#b00;'>${room.banReason}</div>` : ''}
                                    ${!room.isActive && room.banExpiresAt ? `<div style='font-size:0.8em;color:#888;'>Until: ${new Date(room.banExpiresAt).toLocaleString()}</div>` : ''}
                                </td>
                                <td>${new Date(room.createdAt).toLocaleDateString()}</td>
                                <td>
                                    ${room.isActive ? 
                                        `<button class="btn-warning" onclick="banRoom('${room._id}')">Ban</button>` :
                                        `<button class="btn-success" onclick="unbanRoom('${room._id}')">Unban</button>`
                                    }
                                    <button class="btn-danger" onclick="deleteRoom('${room._id}')">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        console.log('No rooms found');
                        const tbody = document.getElementById('roomsTableBody');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No rooms found</td></tr>';
                    }
                } else {
                    console.error('Failed to load rooms:', data.error);
                    const tbody = document.getElementById('roomsTableBody');
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: red;">Error loading rooms: ' + (data.error || 'Unknown error') + '</td></tr>';
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                const tbody = document.getElementById('roomsTableBody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: red;">Error loading rooms: ' + error.message + '</td></tr>';
            }
        }

        // Ban room
        async function banRoom(roomId) {
            if (!confirm('Are you sure you want to ban this room? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/ban-room', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}` 
                    },
                    body: JSON.stringify({
                        roomId: roomId,
                        reason: 'Banned due to user reports',
                        duration: 'permanent'
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Room banned successfully', 'success');
                    loadReportedRooms();
                } else {
                    showNotification('Error banning room: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error banning room:', error);
                showNotification('Error banning room: ' + error.message, 'error');
            }
        }

        // Unban room
        async function unbanRoom(roomId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/unban-room', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ roomId })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadRooms();
                    alert('Room unbanned successfully');
                } else {
                    alert('Error unbanning room: ' + data.error);
                }
            } catch (error) {
                console.error('Error unbanning room:', error);
                alert('Error unbanning room');
            }
        }

        // Delete room
        async function deleteRoom(roomId) {
            if (!confirm('Are you sure you want to delete this room? This action cannot be undone.')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/delete-room', {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ roomId })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadRooms();
                    alert('Room deleted successfully');
                } else {
                    alert('Error deleting room: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Error deleting room');
            }
        }

        // Load detailed analytics
        async function loadDetailedAnalytics() {
            console.log('=== LOADING DETAILED ANALYTICS ===');
            
            try {
                console.log('Starting to load detailed analytics charts...');
                
                // Load all charts in parallel
                await Promise.all([
                    loadDemographics(),
                    loadMessagePatterns(),
                    loadRoomActivity(),
                    loadUserEngagement()
                ]);
                
                console.log('Detailed analytics loaded successfully');
            } catch (error) {
                console.error('Error loading detailed analytics:', error);
            }
        }

        // Load demographics chart
        async function loadDemographics() {
            try {
                console.log('Loading demographics chart...');
                const response = await fetch('/api/admin/analytics/demographics', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                console.log('Demographics data:', data);
                
                if (data.success && data.genderStats) {
                    const config = {
                        type: 'doughnut',
                        data: {
                            labels: data.genderStats.map(item => item._id || 'Unknown'),
                            datasets: [{
                                data: data.genderStats.map(item => item.count),
                                backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'User Demographics' }
                            }
                        }
                    };
                    
                    createChart('demographicsChart', config);
                } else {
                    console.error('No demographics data available');
                    // Show placeholder
                    const canvas = document.getElementById('demographicsChart');
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#666';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data available', canvas.width/2, canvas.height/2);
                }
            } catch (error) {
                console.error('Error loading demographics:', error);
            }
        }

        // Load message patterns chart
        async function loadMessagePatterns() {
            try {
                console.log('Loading message patterns chart...');
                const response = await fetch('/api/admin/analytics/message-patterns', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                console.log('Message patterns data:', data);
                
                if (data.success && data.messagePatterns && data.messagePatterns.length > 0) {
                    const config = {
                        type: 'line',
                        data: {
                            labels: data.messagePatterns.map(item => `${item._id.dayOfWeek || 'Unknown'}:${item._id.hour || 0}h`),
                            datasets: [{
                                label: 'Messages',
                                data: data.messagePatterns.map(item => item.count),
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Message Patterns' }
                            }
                        }
                    };
                    
                    createChart('messagePatternsChart', config);
                } else {
                    console.log('No message patterns data available');
                    // Show placeholder
                    const canvas = document.getElementById('messagePatternsChart');
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#666';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data available', canvas.width/2, canvas.height/2);
                }
            } catch (error) {
                console.error('Error loading message patterns:', error);
            }
        }

        // Load room activity chart
        async function loadRoomActivity() {
            try {
                console.log('Loading room activity chart...');
                const response = await fetch('/api/admin/analytics/room-activity', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                console.log('Room activity data:', data);
                
                if (data.success && data.roomActivity && data.roomActivity.length > 0) {
                    const config = {
                        type: 'bar',
                        data: {
                            labels: data.roomActivity.map(item => item._id || 'Unknown'),
                            datasets: [{
                                label: 'Rooms Created',
                                data: data.roomActivity.map(item => item.count),
                                backgroundColor: '#2196F3'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Room Activity' }
                            }
                        }
                    };
                    
                    createChart('roomActivityChart', config);
                } else {
                    console.log('No room activity data available');
                    // Show placeholder
                    const canvas = document.getElementById('roomActivityChart');
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#666';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data available', canvas.width/2, canvas.height/2);
                }
            } catch (error) {
                console.error('Error loading room activity:', error);
            }
        }

        // Load user engagement chart
        async function loadUserEngagement() {
            try {
                console.log('Loading user engagement chart...');
                const response = await fetch('/api/admin/analytics/user-engagement', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                console.log('User engagement data:', data);
                
                if (data.success && data.userEngagement && data.userEngagement.length > 0) {
                    const config = {
                        type: 'bar',
                        data: {
                            labels: data.userEngagement.map(item => item.username || 'Unknown'),
                            datasets: [{
                                label: 'Messages',
                                data: data.userEngagement.map(item => item.messageCount),
                                backgroundColor: '#FF9800'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'User Engagement' }
                            }
                        }
                    };
                    
                    createChart('userEngagementChart', config);
                } else {
                    console.log('No user engagement data available');
                    // Show placeholder
                    const canvas = document.getElementById('userEngagementChart');
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#666';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data available', canvas.width/2, canvas.height/2);
                }
            } catch (error) {
                console.error('Error loading user engagement:', error);
            }
        }

        // Load announcements
        async function loadAnnouncements() {
            try {
                const response = await fetch('/api/admin/announcements', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const announcementList = document.getElementById('announcementList');
                    announcementList.innerHTML = '';
                    
                    data.announcements.forEach(announcement => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="announcement-item">
                                <div class="announcement-header">
                                    <h4>${announcement.title}</h4>
                                    <span class="announcement-type ${announcement.type}">${announcement.type}</span>
                                </div>
                                <p>${announcement.message}</p>
                                <div class="announcement-footer">
                                    <small>${new Date(announcement.createdAt).toLocaleDateString()}</small>
                                    <button onclick="deleteAnnouncement('${announcement._id}')" class="btn-small btn-danger">Delete</button>
                                </div>
                            </div>
                        `;
                        announcementList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        // Load notification rules
        async function loadNotificationRules() {
            try {
                console.log('Loading notification rules...');
                const response = await fetch('/api/admin/notification-rules', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                if (data.success && data.rules) {
                    console.log('Notification rules loaded:', data.rules);
                    
                    // Populate form fields with saved values (using correct HTML element IDs)
                    document.getElementById('notifyOnBan').checked = data.rules.notifyOnBan || false;
                    document.getElementById('notifyOnUnban').checked = data.rules.notifyOnUnban || false;
                    document.getElementById('notifyOnAnnouncement').checked = data.rules.notifyOnAnnouncement || false;
                    document.getElementById('emailNotifications').checked = data.rules.emailNotifications || false;
                    
                    console.log('Form populated with saved rules');
                } else {
                    console.log('No saved rules found, using defaults');
                    // Set default values if no rules exist
                    document.getElementById('notifyOnBan').checked = false;
                    document.getElementById('notifyOnUnban').checked = false;
                    document.getElementById('notifyOnAnnouncement').checked = false;
                    document.getElementById('emailNotifications').checked = false;
                }
            } catch (error) {
                console.error('Error loading notification rules:', error);
                // Set default values on error
                document.getElementById('notifyOnBan').checked = false;
                document.getElementById('notifyOnUnban').checked = false;
                document.getElementById('notifyOnAnnouncement').checked = false;
                document.getElementById('emailNotifications').checked = false;
            }
        }

        // Switch between sections
        function switchSection(section, event = null) {
            console.log('Switching to section:', section);
            
            // Clean up existing charts before switching
            cleanupCharts();
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show selected section
            const sectionElement = document.getElementById(section + 'Section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
                console.log('Section displayed:', section);
            } else {
                console.error('Section element not found:', section + 'Section');
            }
            
            // Add active class to navigation item
            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            } else {
                // Find the nav item by data-section attribute
                const navItem = document.querySelector(`[data-section="${section}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
            
            // Load data for the section
            if (section === 'users') {
                loadUsers();
            } else if (section === 'reports') {
                loadReports();
            } else if (section === 'reportedRooms') {
                loadReportedRooms();
            } else if (section === 'rooms') {
                loadRooms();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    const section = item.getAttribute('data-section');
                    switchSection(section, event);
                });
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('adminToken');
                window.location.href = '/admin/login';
            });
            
            // Announcements
            document.getElementById('createAnnouncementBtn').addEventListener('click', () => {
                document.getElementById('announcementModal').style.display = 'block';
                document.getElementById('announcementForm').reset();
                loadUsersForSelection();
            });
            
            document.getElementById('closeAnnouncementModal').addEventListener('click', () => {
                document.getElementById('announcementModal').style.display = 'none';
            });
            
            document.getElementById('announcementForm').addEventListener('submit', handleAnnouncementSubmit);
            
            // Handle target selection change
            document.getElementById('announcementTarget').addEventListener('change', (e) => {
                const userSelectionContainer = document.getElementById('userSelectionContainer');
                if (e.target.value === 'specific') {
                    userSelectionContainer.style.display = 'block';
                    loadUsersForSelection();
                } else {
                    userSelectionContainer.style.display = 'none';
                }
            });
            
            // Broadcast
            document.getElementById('broadcastBtn').addEventListener('click', () => {
                document.getElementById('broadcastModal').style.display = 'block';
                document.getElementById('broadcastForm').reset();
            });
            
            document.getElementById('closeBroadcastModal').addEventListener('click', () => {
                document.getElementById('broadcastModal').style.display = 'none';
            });
            
            document.getElementById('broadcastForm').addEventListener('submit', handleBroadcastSubmit);
            
            // Notification rules
            document.getElementById('notificationRulesForm').addEventListener('submit', handleNotificationRulesSubmit);
            
            // Close modals on outside click
            window.addEventListener('click', (event) => {
                const modals = ['announcementModal', 'broadcastModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }

        // Load users for announcement targeting
        async function loadUsersForSelection() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const userSelectionList = document.getElementById('userSelectionList');
                    userSelectionList.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px solid #eee;';
                        userDiv.innerHTML = `
                            <input type="checkbox" id="user_${user._id}" value="${user._id}" style="margin: 0;">
                            <label for="user_${user._id}" style="margin: 0; cursor: pointer; flex: 1;">
                                ${user.username || 'Anonymous'} (${user.email || 'No email'})
                            </label>
                        `;
                        userSelectionList.appendChild(userDiv);
                    });
                }
            } catch (error) {
                console.error('Error loading users for selection:', error);
            }
        }

        // Handle announcement form submission
        async function handleAnnouncementSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const target = formData.get('target');
            let targetUsers = [];
            
            if (target === 'specific') {
                const selectedUsers = document.querySelectorAll('#userSelectionList input[type="checkbox"]:checked');
                selectedUsers.forEach(checkbox => {
                    targetUsers.push(checkbox.value);
                });
                
                if (targetUsers.length === 0) {
                    showNotification('Please select at least one user', 'error');
                    return;
                }
            }
            
            const announcementData = {
                title: formData.get('title'),
                message: formData.get('message'),
                type: formData.get('type'),
                target: target,
                targetUsers: targetUsers
            };
            
            try {
                const response = await fetch('/api/admin/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(announcementData)
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('announcementModal').style.display = 'none';
                    loadAnnouncements();
                    showNotification('Announcement created successfully!', 'success');
                } else {
                    showNotification('Error creating announcement', 'error');
                }
            } catch (error) {
                showNotification('Error creating announcement', 'error');
            }
        }

        // Handle broadcast form submission
        async function handleBroadcastSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const broadcastData = {
                message: formData.get('message'),
                type: formData.get('type')
            };
            
            try {
                const response = await fetch('/api/admin/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(broadcastData)
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('broadcastModal').style.display = 'none';
                    showNotification('Broadcast message sent successfully!', 'success');
                } else {
                    showNotification('Error sending broadcast', 'error');
                }
            } catch (error) {
                showNotification('Error sending broadcast', 'error');
            }
        }

        // Handle notification rules form submission
        async function handleNotificationRulesSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const rulesData = {
                notifyOnBan: formData.get('notifyOnBan') === 'on',
                notifyOnUnban: formData.get('notifyOnUnban') === 'on',
                notifyOnAnnouncement: formData.get('notifyOnAnnouncement') === 'on',
                emailNotifications: formData.get('emailNotifications') === 'on'
            };
            
            try {
                const response = await fetch('/api/admin/notification-rules', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(rulesData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Notification rules updated successfully!', 'success');
                } else {
                    showNotification('Error updating notification rules', 'error');
                }
            } catch (error) {
                showNotification('Error updating notification rules', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Refresh dashboard
        function refreshDashboard() {
            loadDashboard();
            showNotification('Dashboard refreshed!', 'success');
        }

        // Export data
        function exportData() {
            showNotification('Export functionality coming soon!', 'info');
        }

        // Delete announcement
        async function deleteAnnouncement(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/announcements/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    loadAnnouncements();
                    showNotification('Announcement deleted successfully!', 'success');
                } else {
                    showNotification('Error deleting announcement', 'error');
                }
            } catch (error) {
                showNotification('Error deleting announcement', 'error');
            }
        }

        // Ban user
        async function banUser(userId) {
            const reason = prompt('Enter ban reason:');
            if (!reason) return;
            
            const banType = prompt('Enter ban type (permanent/temporary):', 'temporary');
            if (!banType) return;
            
            let duration = null;
            if (banType === 'temporary') {
                duration = prompt('Enter duration in hours:', '24');
                if (!duration) return;
            }
            
            try {
                const response = await fetch('/api/admin/ban-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, reason, banType, duration })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadUsers();
                } else {
                    alert('Error banning user: ' + data.error);
                }
            } catch (error) {
                console.error('Error banning user:', error);
                alert('Error banning user');
            }
        }

        // Unban user
        async function unbanUser(userId) {
            try {
                const response = await fetch('/api/admin/unban-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadUsers();
                } else {
                    alert('Error unbanning user: ' + data.error);
                }
            } catch (error) {
                console.error('Error unbanning user:', error);
                alert('Error unbanning user');
            }
        }

        // Resolve report (for user reports)
        async function resolveUserReport(reportId, status) {
            try {
                const response = await fetch('/api/admin/update-report-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId, status })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadReports();
                } else {
                    alert('Error updating report: ' + data.error);
                }
            } catch (error) {
                console.error('Error updating report:', error);
                alert('Error updating report');
            }
        }

        // Test rooms API
        async function testRoomsAPI() {
            try {
                console.log('Testing rooms API...');
                const response = await fetch('/api/debug/rooms');
                const data = await response.json();
                console.log('Debug rooms data:', data);
                alert(`Found ${data.count} rooms in database`);
            } catch (error) {
                console.error('Error testing rooms API:', error);
                alert('Error testing rooms API: ' + error.message);
            }
        }

        // Test authentication
        async function testAuth() {
            try {
                console.log('Testing authentication...');
                const token = localStorage.getItem('adminToken');
                console.log('Admin token:', token);
                
                if (!token) {
                    alert('No admin token found in localStorage');
                    return;
                }
                
                const response = await fetch('/api/admin/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Auth test response:', data);
                
                if (data.success) {
                    alert('Authentication successful!');
                } else {
                    alert('Authentication failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error testing auth:', error);
                alert('Error testing auth: ' + error.message);
            }
        }

        // Load reported rooms
        async function loadReportedRooms() {
            try {
                document.getElementById('reportedRoomsLoading').style.display = 'block';
                document.getElementById('reportedRoomsTableBody').innerHTML = '';
                document.getElementById('noReportedRooms').style.display = 'none';
                
                console.log('Loading reported rooms...');
                const response = await fetch('/api/admin/reported-rooms', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                console.log('Reported rooms response status:', response.status);
                const data = await response.json();
                console.log('Reported rooms response data:', data);
                
                if (data.success && data.reports) {
                    console.log('Reported rooms loaded:', data.reports);
                    
                    // Apply filter
                    const statusFilter = document.getElementById('reportStatusFilter').value;
                    let filteredReports = data.reports;
                    
                    if (statusFilter !== 'all') {
                        filteredReports = data.reports.filter(report => report.status === statusFilter);
                    }
                    
                    if (filteredReports.length === 0) {
                        document.getElementById('reportedRoomsLoading').style.display = 'none';
                        document.getElementById('noReportedRooms').style.display = 'block';
                        return;
                    }
                    
                    const tbody = document.getElementById('reportedRoomsTableBody');
                    tbody.innerHTML = '';
                    
                    filteredReports.forEach(report => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="room-info">
                                    <strong>${report.roomName || 'Unknown Room'}</strong>
                                    <small>${report.roomId || 'N/A'}</small>
                                </div>
                            </td>
                            <td>
                                <div class="user-info">
                                    <strong>${report.reportedBy?.username || 'Anonymous'}</strong>
                                    <small>${report.reportedBy?.email || 'No email'}</small>
                                </div>
                            </td>
                            <td>
                                <span class="badge badge-${getReportReasonBadge(report.reason)}">${report.reason}</span>
                            </td>
                            <td>
                                <div class="description-cell">
                                    ${report.description || 'No description provided'}
                                </div>
                            </td>
                            <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                            <td>
                                <span class="badge badge-${getStatusBadge(report.status)}">${report.status}</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${report.status === 'pending' ? `
                                        <button class="btn btn-success btn-sm" onclick="resolveReport('${report._id}')">
                                            <i class="fas fa-check"></i> Resolve
                                        </button>
                                        <button class="btn btn-warning btn-sm" onclick="dismissReport('${report._id}')">
                                            <i class="fas fa-times"></i> Dismiss
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="banRoom('${report.roomId}')">
                                        <i class="fas fa-ban"></i> Ban Room
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="viewReportDetails('${report._id}')">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    console.error('Failed to load reported rooms:', data.message);
                    showNotification('Error loading reported rooms', 'error');
                }
            } catch (error) {
                console.error('Error loading reported rooms:', error);
                showNotification('Error loading reported rooms', 'error');
            } finally {
                document.getElementById('reportedRoomsLoading').style.display = 'none';
            }
        }
        
        // Add event listener for status filter
        document.addEventListener('DOMContentLoaded', function() {
            const statusFilter = document.getElementById('reportStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    loadReportedRooms();
                });
            }
        });
        
        // Get badge class for report reason
        function getReportReasonBadge(reason) {
            const badges = {
                'inappropriate': 'danger',
                'spam': 'warning',
                'harassment': 'danger',
                'violence': 'danger',
                'copyright': 'warning',
                'other': 'secondary'
            };
            return badges[reason] || 'secondary';
        }
        
        // Get badge class for status
        function getStatusBadge(status) {
            const badges = {
                'pending': 'warning',
                'resolved': 'success',
                'dismissed': 'secondary'
            };
            return badges[status] || 'secondary';
        }
        
        // Resolve a report
        async function resolveReport(reportId) {
            try {
                const response = await fetch(`/api/admin/reported-rooms/${reportId}/resolve`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Report resolved successfully', 'success');
                    loadReportedRooms();
                } else {
                    showNotification('Error resolving report', 'error');
                }
            } catch (error) {
                console.error('Error resolving report:', error);
                showNotification('Error resolving report', 'error');
            }
        }
        
        // Dismiss a report
        async function dismissReport(reportId) {
            try {
                const response = await fetch(`/api/admin/reported-rooms/${reportId}/dismiss`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Report dismissed successfully', 'success');
                    loadReportedRooms();
                } else {
                    showNotification('Error dismissing report', 'error');
                }
            } catch (error) {
                console.error('Error dismissing report:', error);
                showNotification('Error dismissing report', 'error');
            }
        }
        
        // Ban a room
        async function banRoom(roomId) {
            if (!confirm('Are you sure you want to ban this room? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/ban-room', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}` 
                    },
                    body: JSON.stringify({
                        roomId: roomId,
                        reason: 'Banned due to user reports',
                        duration: 'permanent'
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Room banned successfully', 'success');
                    loadReportedRooms();
                } else {
                    showNotification('Error banning room: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error banning room:', error);
                showNotification('Error banning room: ' + error.message, 'error');
            }
        }
        
        // View report details
        async function viewReportDetails(reportId) {
            try {
                const response = await fetch(`/api/admin/reported-rooms/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                
                if (data.success && data.report) {
                    const report = data.report;
                    
                    // Create details modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    modal.id = 'reportDetailsModal';
                    
                    modal.innerHTML = `
                        <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3>Report Details</h3>
                                <button onclick="closeReportDetailsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Room:</strong> ${report.roomName || 'Unknown'} (${report.roomId || 'N/A'})
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Reported By:</strong> ${report.reportedBy?.username || 'Anonymous'} (${report.reportedBy?.email || 'No email'})
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Reason:</strong> 
                                <span class="badge badge-${getReportReasonBadge(report.reason)}">${report.reason}</span>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Description:</strong>
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-top: 0.5rem;">
                                    ${report.description || 'No description provided'}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Status:</strong> 
                                <span class="badge badge-${getStatusBadge(report.status)}">${report.status}</span>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Reported On:</strong> ${new Date(report.createdAt).toLocaleString()}
                            </div>
                            
                            ${report.resolvedBy ? `
                                <div style="margin-bottom: 1rem;">
                                    <strong>Resolved By:</strong> ${report.resolvedBy.username || 'Unknown Admin'}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Resolved On:</strong> ${new Date(report.resolvedAt).toLocaleString()}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                                <button onclick="closeReportDetailsModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 5px;">Close</button>
                                ${report.status === 'pending' ? `
                                    <button onclick="resolveReport('${report._id}'); closeReportDetailsModal();" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 5px;">Resolve</button>
                                    <button onclick="dismissReport('${report._id}'); closeReportDetailsModal();" style="padding: 0.5rem 1rem; background: #ffc107; color: white; border: none; border-radius: 5px;">Dismiss</button>
                                ` : ''}
                                <button onclick="banRoom('${report.roomId}'); closeReportDetailsModal();" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 5px;">Ban Room</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                } else {
                    showNotification('Error loading report details', 'error');
                }
            } catch (error) {
                console.error('Error loading report details:', error);
                showNotification('Error loading report details', 'error');
            }
        }
        
        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html> 